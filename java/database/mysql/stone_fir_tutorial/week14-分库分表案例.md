## 分库分表实战案例

分库分表部分仅讲解分库分表整体方案的设计, 对于具体落地, 需要数据库中间件支持, 比如Sharding-Sphere, MyCat...



### 128. 亿级用户表如何水平拆分

建议单表数据量不要超过1000w. 最好在500, 100w内. 用上索引基本没问题. 

- 一般来按照user_id进行hash路由.

**问题:** 如果用户通过username/手机号/..之类的登录, 如何定位具体在哪个分表?

- 一般是**建立索引映射表:** (username, userId), (phoneNo, userId) 两张映射表. 然后对映射表按照映射字段进行hash分表.

- 把数据导入ES里, 按照索引等多种聚合复杂查询分析, 为了运营团队.





### 129. 订单系统如何设计数据库

订单类表 即使是小公司也要做分库分表. 



**考虑三个维度:**

- 后端存储按照订单ID去分库分表

- 用户端查询是根据用户信息. 建立(userid, orderid)映射, 映射也要分库分表.
- 运维端查询所有订单. 使用ES来帮忙.



### 130. 跨库跨表分页操作

- ES, 还能实现多种筛选条件.

- 如果硬用MySQL就只能从多个库表中查出来, 在内存里做聚合操作.

- 必须要做跨表分页么?

  可不可以再建立一个适当的索引映射表, 对那个表可以不用跨表.



### 131. 分库分表需要扩容怎么办

- 建议: 刚拆分就尽量多建表, 避免后期增加表.
- 数据库实例增加, 可以把分表均匀迁移到多个库.

???????????????????????????????????????????????????????????????/

? 动态扩容怎么办?

? 不停服迁移表么?





###





















