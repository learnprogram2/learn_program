### 01. 分析核心链路, 是否要上分布式事务

1. 采购流程

   采购部门->采购单->供应商->采购入库->更新库存->商品售卖->采购结算单->财务系统结款->周/月年结算报表

   这个没有实时性和强烈的数据一致性要求, 不用上. 上了反而增加复杂度.

2. **购物流程:**

   购物车选择商品->提交订单->创建订单(待支付)->支付->订单状态(代发货)->扣减库存->调度出库->增加积分->发送短信.

   需要, 很重要, **面向用户的, 实时性和数据一致性要求高.**

3. 退货流程:

   提交退货申请->客服审核->商品寄回->收到确认退货->退货入库单->客服审核->退款

   **有人工参与, 实时性要求不太高, 数据一致性可以审核修改.**

   

### 02. 购物流程环节梳理 -创建订单-支付订单两个分布式事务链条

用户端: 商品加入购物车 -> 结算页面 -> 选择优惠券 -> 提交订单 -> 

订单: 

1. 库存锁定(MQ异步)  -> **创建订单流程** 
   1. 订单中心: 创建订单, 初始化订单状态(待支付),
   2. 库存中心: 锁定库存->异步通知调度中心和WMS锁定库存
   3. 调度中心: 锁定发货流程前的商品
   4. WMS: 锁定本地库存

2. 支付链接生成 - > 用户支付 -> 支付服务收钱
3. 订单中心收到支付成功确认的消息 -> **支付订单流程**
   1. 订单中心: 更新订单状态, 记录日志.
   2. 库存中心: 扣减库存, ->MQ通知 调度中心和WMS扣减库存
   3. 会员中心: 增加积分和成长值
   4. 通知服务: 短信通知用户. 
   5. 订单中心接受WMS的异步通知, 流转订单状态->已发货->确认收货->...



### 03. 分布式事务方案结合业务落地细节

 **创建订单流程**:  订单中心的创建订单 和 库存中心的扣除库存 结合.

- 正常的分布式事务, 从TCC, 可靠消息最终一致性方案, 最大努力通知方案, saga中选择.
- **订单服务和库存扣减, 实时性高, 数据一致性要求高, 所以适用于TCC.**
- **库存中心内通知WMS的流程, 实时性要求不高, 数据一致性要求高, 适合可靠消息最终一致性方案.**

![01_创建订单子流程的分布式事务方案](%E6%A0%B8%E5%BF%83%E9%93%BE%E8%B7%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E5%AE%9E%E6%88%98.assets/01_%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E5%AD%90%E6%B5%81%E7%A8%8B%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%A1%88.png)

**支付订单服务:** 订单中心和库存中心还有其他服务的多个服务结合的事务

- **订单服务和库存扣减还是强结合的, 适用TCC方案**

- **订单支付成功的各种操作, 更适合可靠消息最终一致性方案, 必须要执行成功.**

  通过MQ同时通知多个服务, 然后使用可靠消息最终一致性保证事务成功. 对于不太重要的发短信之类的也可以用最大努力通知.

![02_支付订单子流程的分布式事务方案](%E6%A0%B8%E5%BF%83%E9%93%BE%E8%B7%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E5%AE%9E%E6%88%98.assets/02_%E6%94%AF%E4%BB%98%E8%AE%A2%E5%8D%95%E5%AD%90%E6%B5%81%E7%A8%8B%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%96%B9%E6%A1%88.png)





## 创建订单流程 -分布式事务改造

 **订单中心的创建订单 和 库存中心的扣除库存 结合.**

1. 服务提供者库存中心改造: 

   1. 提供TCC三接口
   2. 数据库表添加: bytejta为了byteTransaction来适配.
   3. 适配框架的代码注解和配置.


- try阶段: 创建订单,初始状态init, 库存中心扣除可销售库存.
- confirm阶段: 当但中心流转订单状态, 库存中心冻结库存确认.
- cancel阶段: 订单取消, 然后库存中心放回可销售库存.



















## 支付订单流程























