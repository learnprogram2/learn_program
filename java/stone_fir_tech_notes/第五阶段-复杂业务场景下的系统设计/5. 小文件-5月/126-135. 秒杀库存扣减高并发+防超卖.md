### 126. 秒杀抢购请求并发 不能 压给数据库 - 要用缓存

**MySQL并发修改: 如果算一条商品修改行锁, 请求串行, 都会阻塞住.** 

MySQL均匀的并发修改: 大概2K上下

- **秒杀架构通常会用Redis或者其他NoSQL来存放库存**

  **把秒杀商品的库存, 提前加载到Redis缓存里来**

- **可销售库存, 锁定库存, 已销售库存**. 三个指标实时监控



### 127. 为秒杀系统独立部署一套Redis集群

可销售库存，锁定库存，已销售库存，还是三个库存，在秒杀管理平台，可以看到这三个指标的实时监控数据





### 128. 商品库存 在 redis中的存储结构

```redis
seckill::product::153 = {
	sale_stock_amount: 3000,
	locked_stock_amount: 0,
	saled_stock_amount: 0
}
```

- **redis存储:** 主要是库存情况.
  - 总数量
  - 锁定库存
  - 已销售库存
- 冻结库存，freezed_stock_amount，是在库存系统的表里

 

### 129. 基于Redis缓存 秒杀抢购 流程

1. 抢购按钮在抢购时间开始之后才可以点击
2. 抢购开始, 发起抢购请求
3. 假设秒杀抢购系统做了充足的Tomcat性能调优, 每台4核8G的服务器可以抗每秒1000个请求, 部署 10台机器就可以了
4. 得先判断一下商品的sale_stock_amount, 可售库存是否充足

5. **如果有可销售库存就扣减, 增加锁定库存;**
6. **异步下单流程: 等用户完成支付后, 就会扣减redis里的锁定库存, 增加已销售库存**

- **缺陷: 并发场景下，绝对数据混乱，也就是所谓的库存超卖**



### 130. 超卖问题分析

```redis
seckill::product::153 = {
    sale_stock_amount: 3000,
    locked_stock_amount: 0,
    saled_stock_amount: 0
}
```

- **分布式锁:** 性能问题: 依托停顿+轮询去检查锁. 一个就要几毫秒, 排队, 再加上拥挤, 一秒钟可能就几百并发.

- **FIFO内存队列**: 把请求都放入队列, 然后一个消费者统一去redis中扣减库存.

  这个不适合多个服务共同扣减库存啊. 如果用MQ又不能保证接口时间和并发.

- **乐观锁:** 每个库存数据绑定一个版本号. 但是秒杀的话修改并发大, 不是乐观锁读多写少的场景.

- **仿Redis分布式锁, 使用`Lua脚本`**: redis保证命令执行顺序.

  会把查询库存数量是否可以抢购 + 更新一堆库存字段 + 是否抢购成功的返回值，这些逻辑封装在一个lua脚本里.

  - **库存分段,** 分到多个Redis里面, 分散并发, 后期抢不到的话重试其他的server.
  - 支付完成: 乐观锁watch + pipeline提交, 可以保证单独执行. 除非redis挂掉.

  



### 133. 秒杀链路的 下单和支付环节

秒杀抢购进行中，请耐心等待，页面/APP得不断的发送请求，比如说每隔1s发送一个请求到后台去查询，这个秒杀抢购的请求对应的订单是否异步的生成了，页面上显示的就是，不好意思，商品已经售罄





### 134. 秒杀抢购系统还需要限流、防刷和防重吗? 

不需要了, 前面nginx和商业服务都有校验. 

**专注于redis的库存扣减.**









### 135. 秒杀服务 基础优化: Tomcat架构原理和优化手段 TODO



![秒杀系统架构图 (126-135.%20%E5%90%8E%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.assets/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE%20(2).png)](126~135%E8%B5%84%E6%96%99/135_%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E9%9C%80%E8%A6%81%E4%BA%86%E8%A7%A3Tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E5%92%8C%E4%BC%98%E5%8C%96%E6%89%8B%E6%AE%B5/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE%20(2).png)

![image-20210621203250232](126-135.%20%E7%A7%92%E6%9D%80%E5%BA%93%E5%AD%98%E6%89%A3%E5%87%8F%E9%AB%98%E5%B9%B6%E5%8F%91+%E9%98%B2%E8%B6%85%E5%8D%96.assets/image-20210621203250232.png)















